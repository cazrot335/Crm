<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ScholarBot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      font-family: 'Inter', sans-serif;
    }
    .scroll-container::-webkit-scrollbar { width: 6px; }
    .scroll-container::-webkit-scrollbar-track { background: transparent; }
    .scroll-container::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    .scroll-container::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
    .prose h1, .prose h2, .prose h3 { margin-bottom: 0.5em; margin-top: 1em; }
    .prose ul, .prose ol { margin-top: 0.5em; margin-bottom: 0.5em; }
    .sidebar-item:hover .delete-btn { opacity: 1; }
  </style>
</head>
<body class="bg-gray-100">

<div class="flex h-screen w-full">
    <aside class="w-64 bg-white border-r border-gray-200 flex-col p-4 hidden md:flex">
        <div class="flex items-center space-x-3 mb-6">
            <div class="bg-indigo-600 p-2 rounded-lg">
              <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41a60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.906 59.906 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg>
            </div>
            <h1 class="text-xl font-semibold text-gray-800">ScholarBot</h1>
        </div>
        <button id="newChatBtn" class="w-full flex items-center justify-center space-x-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            <span>New Chat</span>
        </button>
        <div class="mt-8 flex-1 overflow-y-auto scroll-container pr-2">
            <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Recent</h2>
            <div id="recent-chats-container" class="mt-2 space-y-1">
                </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen bg-gray-50">
        <header class="p-4 flex justify-end items-center w-full border-b bg-white">
            <div class="flex items-center space-x-4">
                 <select id="roleSelector" class="bg-gray-100 border border-gray-200 rounded-lg px-3 py-1.5 text-sm font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="student">üéì Student</option>
                    <option value="counselor">üßë‚Äçüíº Counselor</option>
                </select>
                <select id="apiSelector" class="bg-gray-100 border border-gray-200 rounded-lg px-3 py-1.5 text-sm font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="gemini">Gemini</option>
                    <option value="deepseek">DeepSeek</option>
                    <option value="gpt-3.5">GPT-3.5</option>
                </select>
            </div>
        </header>

        <div id="chat-container" class="scroll-container flex-1 overflow-y-auto p-4 md:p-6">
            <div id="welcome-screen" class="w-full max-w-3xl mx-auto flex flex-col items-center justify-center h-full">
                <div class="p-4 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg">
                    <svg class="w-12 h-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41a60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.906 59.906 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg>
                </div>
                <h2 id="welcome-heading" class="mt-6 text-4xl font-bold text-gray-700">Hello! How can I help today?</h2>
                
                <div id="suggestion-cards" class="mt-12 w-full grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>
            <div id="chat-log" class="w-full max-w-3xl mx-auto space-y-6 hidden">
                </div>
        </div>
        
        <div class="px-4 pb-4 w-full bg-gray-50">
            <div class="w-full max-w-3xl mx-auto">
                <form id="chatForm" class="w-full">
                    <div class="relative w-full p-2 bg-white border border-gray-200 rounded-2xl shadow-sm flex items-center space-x-2">
                        <textarea id="userInput" class="flex-grow bg-transparent px-3 py-2 text-base text-gray-800 placeholder-gray-500 focus:outline-none resize-none" placeholder="Ask about universities, visas, or paste a URL..." rows="1" required></textarea>
                        <button type="button" id="scrapeBtn" title="Scrape URL" class="h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-500 hover:text-indigo-600 transition-colors flex-shrink-0">
                             <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>
                        </button>
                        <button type="submit" title="Send Message" class="bg-indigo-600 hover:bg-indigo-700 text-white h-9 w-9 flex items-center justify-center rounded-lg transition-colors flex-shrink-0">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"> <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009.586 15H11a1 1 0 00.707-.293l.16-.16a1 1 0 00.293-.707V5.414a1 1 0 00-1.586-.816l-5.728 2.864A1 1 0 002 8.228V14a1 1 0 102 0V8.586l4.293-2.147a1 1 0 011.08.158l3.64 3.64a1 1 0 001.414-1.414l-3.64-3.64a1 1 0 00-.158-1.08z" /> </svg>
                        </button>
                    </div>
                </form>
                <p class="text-xs text-center text-gray-400 mt-2">ScholarBot can make mistakes. Consider checking important information.</p>
            </div>
        </div>
    </main>
</div>

<script>
    // --- DOM Elements ---
    const chatLog = document.getElementById('chat-log');
    const chatForm = document.getElementById("chatForm");
    const userInput = document.getElementById("userInput");
    const roleSelector = document.getElementById("roleSelector");
    const apiSelector = document.getElementById("apiSelector");
    const scrapeBtn = document.getElementById("scrapeBtn");
    const newChatBtn = document.getElementById("newChatBtn");
    const welcomeScreen = document.getElementById('welcome-screen');
    const suggestionCardsContainer = document.getElementById('suggestion-cards');
    const recentChatsContainer = document.getElementById('recent-chats-container');

    // --- State Management ---
    let allChats = [];
    let activeChatId = null;
    
    // ================== NEW PROMPTS START HERE ==================
    const studentSuggestions = [
        { title: "Compare Countries", prompt: "Compare living costs and part-time work opportunities for students in Australia vs. Canada.", icon: "üåè" },
        { title: "Help with SOP", prompt: "Help me outline a Statement of Purpose for a Master's in Business Analytics.", icon: "‚úçÔ∏è" },
        { title: "Create a Budget", prompt: "Create a sample monthly budget for a student living in a small city in Germany.", icon: "üí∂" },
        { title: "Career Prospects", prompt: "What are the job prospects in the US after an MS in Robotics?", icon: "ü§ñ" },
        { title: "Test Prep Plan", prompt: "Give me a 1-week study plan for the IELTS Listening section.", icon: "üéß" },
        { title: "Student Life", prompt: "Tell me about the student life and campus culture at universities in the UK.", icon: "üéâ" }
    ];
    const counselorSuggestions = [
        { title: "Shortlist Universities", prompt: "Suggest 3 ambitious, 3 moderate, and 3 safe US universities for a student with a 3.5 GPA and 320 GRE wanting an MS in CS.", icon: "üéØ" },
        { title: "Create a Workflow", prompt: "Create a detailed checklist for a new student's onboarding process, from the first call to visa filing.", icon: "üìã" },
        { title: "Draft Reminder Email", prompt: "Draft a polite but firm reminder email for a student who needs to submit their financial documents.", icon: "‚úâÔ∏è" },
        { title: "Summarize Policy Changes", prompt: "Summarize the key changes to Canada's study permit regulations announced in the last 3 months.", icon: "üá®üá¶" },
        { title: "Compare Program Types", prompt: "What are the pros and cons of a 1-year Master's in the UK vs. a 2-year Master's in the USA?", icon: "‚öñÔ∏è" },
        { title: "Generate JSON", prompt: "Provide a JSON template for storing a student's basic profile information, including academics and test scores.", icon: "üíæ" }
    ];
    // =================== NEW PROMPTS END HERE ===================


    // --- Dynamic Resizing for Textarea ---
    userInput.addEventListener('input', () => {
        userInput.style.height = 'auto';
        userInput.style.height = (userInput.scrollHeight) + 'px';
    });
    
    // --- Chat History Management ---
    function saveChats() {
        localStorage.setItem('scholarBotChats', JSON.stringify(allChats));
    }

    function loadChats() {
        const saved = localStorage.getItem('scholarBotChats');
        if (saved) {
            allChats = JSON.parse(saved);
        }
    }

    function renderSidebar() {
        recentChatsContainer.innerHTML = '';
        if (allChats.length === 0) {
            recentChatsContainer.innerHTML = `<p class="text-sm text-gray-400 px-2">No recent chats.</p>`;
            return;
        }
        allChats.forEach(chat => {
            const isActive = chat.id === activeChatId;
            const item = document.createElement('div');
            item.className = `sidebar-item group flex items-center justify-between p-2 rounded-lg cursor-pointer ${isActive ? 'bg-indigo-100' : 'hover:bg-gray-100'}`;
            item.setAttribute('data-id', chat.id);
            item.innerHTML = `
                <span class="text-sm font-medium truncate ${isActive ? 'text-indigo-700' : 'text-gray-700'}">${chat.title}</span>
                <button class="delete-btn opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-600 transition-opacity" data-id="${chat.id}" title="Delete Chat">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            item.addEventListener('click', (e) => {
                if (e.target.closest('.delete-btn')) {
                    deleteChat(chat.id);
                } else {
                    loadChat(chat.id);
                }
            });
            recentChatsContainer.appendChild(item);
        });
    }

    function deleteChat(chatId) {
        if (!confirm("Are you sure you want to delete this chat?")) return;
        
        allChats = allChats.filter(c => c.id !== chatId);
        saveChats();
        
        if (activeChatId === chatId) {
            if (allChats.length > 0) {
                loadChat(allChats[0].id);
            } else {
                startNewChat();
            }
        }
        renderSidebar();
    }

    function loadChat(chatId) {
        const chat = allChats.find(c => c.id === chatId);
        if (!chat) return;

        activeChatId = chatId;
        roleSelector.value = chat.role;
        chatLog.innerHTML = '';

        if (chat.history.length > 0) {
            chat.history.forEach(msg => addMessage(msg.role === 'user' ? 'You' : 'ScholarBot', msg.content, true));
            welcomeScreen.classList.add('hidden');
            chatLog.classList.remove('hidden');
        } else {
            welcomeScreen.classList.remove('hidden');
            chatLog.classList.add('hidden');
            updateWelcomeScreen();
        }

        renderSidebar();
        document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
    }

    // --- UI/DOM Manipulation Functions ---
    function updateWelcomeScreen() {
        const role = roleSelector.value;
        const suggestions = role === 'student' ? studentSuggestions : counselorSuggestions;
        suggestionCardsContainer.innerHTML = '';
        suggestions.forEach(s => {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 hover:shadow-md transition-all';
            card.innerHTML = `<div class="flex items-center space-x-3"><span class="text-2xl">${s.icon}</span><p class="font-medium text-gray-700">${s.title}</p></div>`;
            card.onclick = () => {
                userInput.value = s.prompt;
                userInput.style.height = 'auto';
                userInput.style.height = (userInput.scrollHeight) + 'px';
                chatForm.dispatchEvent(new Event('submit'));
            };
            suggestionCardsContainer.appendChild(card);
        });
    }

    function formatMessage(content) {
        return `<div class="prose prose-sm prose-slate max-w-none text-gray-700">${marked.parse(content)}</div>`;
    }

    function addMessage(sender, message, isLoadingHistory = false) {
        const isBot = sender === "ScholarBot";
        const msgContainer = document.createElement('div');
        msgContainer.className = `flex items-start gap-3 ${isBot ? '' : 'justify-end'}`;

        const botAvatar = `<div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center flex-shrink-0 text-white font-bold text-sm">SB</div>`;
        const userAvatar = `<div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0 text-white font-bold text-sm">You</div>`;

        if (isBot) {
            msgContainer.innerHTML = `
                ${botAvatar}
                <div class="flex-1 min-w-0 bg-white border border-gray-200 rounded-xl rounded-tl-none p-4">
                    <div class="font-bold text-sm text-gray-800 mb-2">ScholarBot</div>
                    <div class="message-content">${formatMessage(message)}</div>
                     ${isLoadingHistory ? `<div class="mt-3 border-t pt-2"><button onclick="copyToClipboard(this)" class="p-1 rounded-md hover:bg-gray-100 text-gray-500" title="Copy"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3.25H5.25a2 2 0 0 0-2 2v10.5a2 2 0 0 0 2 2h10.5a2 2 0 0 0 2-2V5.25a2 2 0 0 0-2-2H13.5v-1h-1v1H7.5v-1h-1v1zM6.25 5.25h8.5V16a.75.75 0 0 1-.75.75H6.5a.75.75 0 0 1-.75-.75V5.25z"/></svg></button></div>` : ''}
                </div>`;
        } else {
             msgContainer.innerHTML = `
                <div class="flex-1 min-w-0 bg-indigo-600 text-white rounded-xl rounded-tr-none p-4">
                    <p class="message-content break-words">${message}</p>
                </div>
                ${userAvatar}`;
        }
        chatLog.appendChild(msgContainer);
    }
    
    function addThinkingMessage() {
        const msgDiv = document.createElement("div");
        msgDiv.id = "thinking-message";
        msgDiv.className = 'flex items-start gap-3';
        
        const botAvatar = `<div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center flex-shrink-0 text-white font-bold text-sm animate-pulse">SB</div>`;
        const thinkingDots = `<div class="flex-1 min-w-0 bg-white border border-gray-200 rounded-xl rounded-tl-none p-4">
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                                </div>
                              </div>`;
        
        msgDiv.innerHTML = `${botAvatar}${thinkingDots}`;
        chatLog.appendChild(msgDiv);
    }

    function updateLastBotMessage(content) {
        const thinkingMsg = document.getElementById("thinking-message");
        if (!thinkingMsg) return;

        const botAvatar = `<div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center flex-shrink-0 text-white font-bold text-sm">SB</div>`;
        const messageBubble = `
            <div class="flex-1 min-w-0 bg-white border border-gray-200 rounded-xl rounded-tl-none p-4">
                <div class="font-bold text-sm text-gray-800 mb-2">ScholarBot</div>
                <div class="message-content">${formatMessage(content)}</div>
                <div class="mt-3 border-t pt-2">
                    <button onclick="copyToClipboard(this)" class="p-1 rounded-md hover:bg-gray-100 text-gray-500" title="Copy">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3.25H5.25a2 2 0 0 0-2 2v10.5a2 2 0 0 0 2 2h10.5a2 2 0 0 0 2-2V5.25a2 2 0 0 0-2-2H13.5v-1h-1v1H7.5v-1h-1v1zM6.25 5.25h8.5V16a.75.75 0 0 1-.75.75H6.5a.75.75 0 0 1-.75-.75V5.25z"/></svg>
                    </button>
                </div>
            </div>`;

        thinkingMsg.innerHTML = `${botAvatar}${messageBubble}`;
        thinkingMsg.removeAttribute('id');
    }
    
    function copyToClipboard(buttonElement) {
        const messageContent = buttonElement.closest('.flex-1').querySelector('.message-content').innerText;
        navigator.clipboard.writeText(messageContent).then(() => {
            buttonElement.innerHTML = `<svg class="w-4 h-4 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>`;
            setTimeout(() => {
                 buttonElement.innerHTML = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3.25H5.25a2 2 0 0 0-2 2v10.5a2 2 0 0 0 2 2h10.5a2 2 0 0 0 2-2V5.25a2 2 0 0 0-2-2H13.5v-1h-1v1H7.5v-1h-1v1zM6.25 5.25h8.5V16a.75.75 0 0 1-.75.75H6.5a.75.75 0 0 1-.75-.75V5.25z"/></svg>`;
            }, 2000);
        });
    }

    // --- Core Logic ---
    async function fetchWithTimeout(resource, options = {}) {
      const { timeout = 8000 } = options;
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      const response = await fetch(resource, { ...options, signal: controller.signal });
      clearTimeout(id);
      return response;
    }

    async function generateChatTitle(firstQuery) {
        try {
            const titlePrompt = {
                role: "user",
                content: `Generate a very short, concise title (4 words max) for a conversation that starts with this user query: "${firstQuery}". Do not use quotes in your response.`
            };
            const response = await fetchWithTimeout("http://localhost:3000/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: 'gpt-3.5', messages: [titlePrompt] }),
                timeout: 5000
            });
            if (!response.ok) return "New Chat";
            const data = await response.json();
            return data.choices?.[0]?.message?.content.trim().replace(/"/g, '') || "New Chat";
        } catch (error) {
            console.error("Title generation failed:", error);
            return "New Chat";
        }
    }

    async function sendMessage(input, scrapeUrl = null) {
      welcomeScreen.classList.add('hidden');
      chatLog.classList.remove('hidden');

      const currentChat = allChats.find(c => c.id === activeChatId);
      if (!currentChat) return;

      addMessage("You", input);
      currentChat.history.push({ role: "user", content: input });
      document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
      
      if (currentChat.history.length === 1) {
          generateChatTitle(input).then(title => {
              currentChat.title = title;
              renderSidebar();
              saveChats();
          });
      }

      addThinkingMessage();
      document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;

      // ================== NEW SYSTEM PROMPTS START HERE ==================
      const studentSystemPrompt = `You are ScholarBot, a friendly and encouraging personal guide for students planning to study abroad. Your main goal is to make complex topics like visa applications and university selection feel simple and manageable.

**Your core tasks are:**
- To provide helpful, accurate, and supportive advice on universities, courses, visas, and scholarships.
- To break down complex processes into simple, step-by-step lists.
- To use tables to compare options (like universities or countries).
- To always end your response with a helpful follow-up question to keep the conversation going.

Maintain a positive and motivational tone. Use markdown (bolding, lists) to keep your answers organized and easy to read.`;
      
      const counselorSystemPrompt = `You are ScholarBot, an expert AI assistant and workflow automation tool for study-abroad counselors. Your purpose is to maximize efficiency by handling data, drafting communications, and providing rapid, accurate information.

**Your core capabilities include:**
- **Student Profile Analysis:** Suggesting universities based on a student's academic profile, test scores, and preferences.
- **Template Generation:** Drafting professional emails, checklists, and SOP/LOR outlines.
- **Data Summarization:** Providing concise summaries of policy updates, visa requirements, and university rankings.
- **Structured Data Output:** Generating responses in formats like JSON, CSV, or markdown tables when requested.

Your tone must be professional, data-driven, and concise. Get straight to the point and provide actionable information.`;
      // =================== NEW SYSTEM PROMPTS END HERE ===================

      const systemPromptContent = currentChat.role === "student" ? studentSystemPrompt : counselorSystemPrompt;
      const systemPrompt = { role: "system", content: systemPromptContent };
      const messages = [systemPrompt, ...currentChat.history];
      
      try {
        const response = await fetch("http://localhost:3000/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ model: apiSelector.value, messages, scrape: scrapeUrl })
        });

        if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
        const data = await response.json();
        let reply = data.choices?.[0]?.message?.content || "I'm sorry, I couldn't get a response. Please try again.";
        
        currentChat.history.push({ role: "assistant", content: reply });
        updateLastBotMessage(reply);

      } catch (err) {
        console.error(err);
        updateLastBotMessage(`‚ùå **Error:** Unable to get a response. Please check the server connection and try again. (${err.message})`);
      }
      saveChats();
      document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
    }

    function startNewChat(isInitialLoad = false) {
        const newId = Date.now();
        const newChat = {
            id: newId,
            title: "New Chat",
            history: [],
            role: roleSelector.value
        };
        allChats.unshift(newChat);
        activeChatId = newId;

        chatLog.innerHTML = '';
        chatLog.classList.add('hidden');
        welcomeScreen.classList.remove('hidden');
        
        if (!isInitialLoad) {
          saveChats();
        }
        updateWelcomeScreen();
        renderSidebar();
    }

    // --- Event Listeners ---
    chatForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const input = userInput.value.trim();
      if (input) {
        sendMessage(input);
        userInput.value = "";
        userInput.style.height = 'auto';
      }
    });

    scrapeBtn.addEventListener("click", () => {
      const input = userInput.value.trim();
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      const urls = input.match(urlRegex);
      if (urls && urls[0]) {
        sendMessage(`Please summarize the key academic information from this website for me. URL: ${urls[0]}`, urls[0]);
        userInput.value = "";
        userInput.style.height = 'auto';
      } else {
        alert("‚ö†Ô∏è Please enter a valid URL in the input box to scrape.");
      }
    });

    roleSelector.addEventListener("change", (e) => {
        const currentChat = allChats.find(c => c.id === activeChatId);
        if (currentChat && currentChat.history.length === 0) {
            currentChat.role = e.target.value;
            saveChats();
            updateWelcomeScreen();
        } else {
             startNewChat();
        }
    });

    newChatBtn.addEventListener('click', () => startNewChat());
    window.addEventListener("DOMContentLoaded", () => {
        loadChats();
        if (allChats.length === 0) {
            startNewChat(true);
        } else {
            loadChat(allChats[0].id);
        }
        renderSidebar();
    });
</script>
</body>
</html>